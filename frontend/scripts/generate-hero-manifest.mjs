import fs from "node:fs";
import path from "node:path";

const heroDir = path.join(process.cwd(), "public", "Hero");
const outFile = path.join(process.cwd(), "lib", "heroImages.ts");
const allowedExts = new Set([".png", ".jpg", ".jpeg", ".webp", ".avif", ".gif"]);

if (!fs.existsSync(heroDir)) {
  console.error(`[hero-manifest] Directory not found: ${heroDir}`);
  process.exit(1);
}

const dirEntries = fs.readdirSync(heroDir, {withFileTypes: true});

const rootFiles = dirEntries
  .filter((dirent) => dirent.isFile())
  .map((dirent) => dirent.name)
  .filter((name) => allowedExts.has(path.extname(name).toLowerCase()))
  .sort((a, b) => a.localeCompare(b, "en"));

const subdirectories = dirEntries.filter((dirent) => dirent.isDirectory());

const heroImagePaths = rootFiles.map((name) => `/Hero/${name}`);

const sections = subdirectories.map((dirent) => {
  const dirName = dirent.name;
  const files = fs
    .readdirSync(path.join(heroDir, dirName), {withFileTypes: true})
    .filter((child) => child.isFile())
    .map((child) => child.name)
    .filter((name) => allowedExts.has(path.extname(name).toLowerCase()))
    .sort((a, b) => a.localeCompare(b, "en"));

  const paths = files.map((name) => `/Hero/${dirName}/${name}`);
  const constName = `${dirName.replace(/([a-z0-9])([A-Z])/g, "$1_$2").replace(/[^a-zA-Z0-9]+/g, "_").toUpperCase()}_HERO_IMAGES`;

  return {constName, paths};
});

const header = `// AUTO-GENERATED by scripts/generate-hero-manifest.mjs
// Do not edit manually.
`;

const lines = [
  header,
  `export const HERO_IMAGES = ${JSON.stringify(heroImagePaths, null, 2)} as const;`,
  `export type HeroImage = (typeof HERO_IMAGES)[number];`,
  ...sections.map(
    ({constName, paths}) => `\nexport const ${constName} = ${JSON.stringify(paths, null, 2)} as const;`
  ),
];

fs.writeFileSync(outFile, lines.join("\n") + "\n", "utf8");

console.log(
  `[hero-manifest] ${heroImagePaths.length} home images, ${
    sections.length
  } sections â†’ ${path.relative(process.cwd(), outFile)}`
);
